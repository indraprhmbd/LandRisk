generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(uuid())
  kindeId      String   @unique
  email        String   @unique
  name         String?
  givenName    String?
  familyName   String?
  picture      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  parcels      Parcel[]
  reports      Report[]
}

model Parcel {
  id                   String   @id @default(uuid())
  location_name        String
  latitude             Float
  longitude            Float
  land_area            Float
  zoning_category      String

  soil_index           Float
  flood_index          Float
  environmental_index  Float
  zoning_index         Float
  topography_index     Float

  data_completeness    Float
  model_consistency    Float
  data_recency         Float

  last_updated         DateTime
  data_source_label    String

  // Caching & Source Tracking
  is_offline_mode      Boolean  @default(false)
  api_cache_timestamp  DateTime @default(now())
  
  // User tracking
  userId               String?
  user                 User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  created_at           DateTime @default(now())

  reports              Report[]

  @@index([latitude, longitude])
  @@index([userId])
}

model Report {
  id                   String   @id @default(uuid())
  
  // Ownership
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parcelId             String
  parcel               Parcel   @relation(fields: [parcelId], references: [id], onDelete: Cascade)
  
  // Risk Assessment Data (snapshot at report generation time)
  risk_score           Float
  classification       String
  dominant_factor      String
  factor_breakdown     Json
  
  // Confidence Data
  confidence_score     Float
  completeness_score   Float
  consistency_score    Float
  recency_score        Float
  low_integrity        Boolean
  
  // AI Interpretation
  summary              String
  key_observations     Json
  recommended_action   String
  limitations          String
  
  // Metadata
  location_name        String
  coordinates          String
  land_area            Float
  zoning_category      String
  data_source          String
  
  createdAt            DateTime @default(now())
  
  @@index([userId])
  @@index([parcelId])
}
